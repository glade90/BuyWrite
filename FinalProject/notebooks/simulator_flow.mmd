flowchart TD

    %% Layout Anchor
    TOP[Anchor]
    TOP -.-> NB
    TOP -.-> SIM

    %% External Systems
    YF[/"Yahoo Finance"/]
    WP[/"Wikipedia"/]
    FS[/"File System"/]

    %% A. BuyWrite Notebook
    subgraph NB["A. BuyWrite Notebook (ipynb)"]
        BATCH[Batch Downloader]
        CALLSIM[Call BuyWrite Portfolio Simulator]
        BATCH -.-> CALLSIM
    end

    %% B. Create Volatility Summary
    subgraph VOLDF["B. Create Volatility Summary"]
        GETDATA[Get Stock Data]
        CALCS[Calc log returns, rolling vols, Z-scores]
        GETDATA -.-> CALCS
    end

    %% C. BuyWrite Portfolio Simulator
    subgraph SIM["C. BuyWrite Portfolio Simulator"]
        INIT[Init]
        RUN[Run Simulation]
        VOL[Get All Dates - vol summary]
        ROLL[Roll or Replace]
        SCREEN[Screen and Rank]
        ZSCORE[Breakout Rank - Zscore]
        DIR[Determine Direction]
        CORR[Check Correlation Limits]
        SECTOR[Manage Sector Limits]
        ENTER[Enter Position]
        LOG[Log to BuyWrite Log]
        RESULTS[results_df]

        subgraph OPTIM["E. Optimizer (.py)"]
            INITOPT[Instantiate Simulator]
            RUNOPT[Run Optimization]
            SUMMARY[Log Optimization Summary]
        end

        RUN -.-> VOL -.-> ROLL
        ROLL -.-> SCREEN -.-> ZSCORE
        SCREEN -.-> DIR
        SCREEN -.-> CORR
        SCREEN -.-> SECTOR
        ROLL -.-> ENTER -.-> LOG

        INITOPT -.-> RUNOPT
        RUNOPT -.-> RUN
        RESULTS -.-> RUNOPT -.-> SUMMARY
    end

    %% D. Simulate BuyWrite
    subgraph SIMULATE["D. Simulate BuyWrite"]
        CREATE[Create Position]
        PREMIUM[Determine Premium]
        OUTCOME[Simulate Outcome]
        PNL[Calculate P&L]

        subgraph PRICING["V. Pricing Models"]
            CALLPRICE[Black-Scholes Call]
            PUTPRICE[Black-Scholes Put]
        end

        PREMIUM -.-> CALLPRICE
        PREMIUM -.-> PUTPRICE
    end

    ENTER -.-> CREATE
    CREATE -.-> PREMIUM -.-> OUTCOME -.-> PNL -.-> ENTER

    %% External Data Flow
    YF -.-> BATCH
    WP -.-> BATCH
    BATCH -.-> FS
    FS -.-> GETDATA
    CALCS -.-> FS
    CALLSIM -.-> INIT
    CALLSIM -.-> RUN
    LOG -.-> FS
    SUMMARY -.-> FS
    NB -.-> SIM
    SIM -.-> SIMULATE

    %% Universal style
    classDef defaultLinkStyle stroke:#1f77b4,stroke-width:2px,stroke-dasharray:5,5;
    linkStyle default stroke:#1f77b4,stroke-dasharray:5,5;
